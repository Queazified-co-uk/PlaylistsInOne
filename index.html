<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Playlists → One</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; text-align: center; }
    button { padding: 0.5rem 1rem; margin: 0.5rem; font-size: 1rem; }
    #status { margin-top: 1rem; color: green; }
  </style>
</head>
<body>
  <h1>Playlists → One</h1>
  <div id="login-section">
    <button id="login-btn">Login with Spotify</button>
  </div>
  <div id="app-section" style="display:none;">
    <button id="merge-btn">Merge My Playlists</button>
    <button id="logout-btn">Logout</button>
    <p id="status"></p>
  </div>

  <script>
    const CLIENT_ID = "2cf9bbde938149269d0da9bb6438ab40";
    const REDIRECT_URI = "https://playlistsinone.queazified.co.uk/callback";
    const SCOPES = [
      "playlist-read-private",
      "playlist-read-collaborative",
      "playlist-modify-public",
      "playlist-modify-private"
    ].join(" ");

    function getTokenFromHash() {
      const hash = window.location.hash;
      if (!hash) return null;
      const params = new URLSearchParams(hash.substring(1));
      return params.get("access_token");
    }

    function setToken(token) {
      localStorage.setItem("spotify_token", token);
    }

    function getToken() {
      return localStorage.getItem("spotify_token");
    }

    function clearToken() {
      localStorage.removeItem("spotify_token");
    }

    function updateUI() {
      if (getToken()) {
        document.getElementById("login-section").style.display = "none";
        document.getElementById("app-section").style.display = "block";
      } else {
        document.getElementById("login-section").style.display = "block";
        document.getElementById("app-section").style.display = "none";
      }
    }

    async function mergePlaylists() {
      const status = document.getElementById("status");
      const token = getToken();
      if (!token) return;

      status.textContent = "Fetching playlists...";
      try {
        const playlistsRes = await fetch("https://api.spotify.com/v1/me/playlists?limit=50", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const playlistsData = await playlistsRes.json();
        const playlists = playlistsData.items;

        let trackURIs = [];
        for (const playlist of playlists) {
          const tracksRes = await fetch(playlist.tracks.href, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const tracksData = await tracksRes.json();
          trackURIs.push(...tracksData.items.map(item => item.track.uri));
        }

        const userRes = await fetch("https://api.spotify.com/v1/me", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const user = await userRes.json();

        const createPlaylistRes = await fetch(`https://api.spotify.com/v1/users/${user.id}/playlists`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            name: "Playlists → One",
            description: "Merged by playlistsinone.queazified.co.uk",
            public: false,
          }),
        });

        const createdPlaylist = await createPlaylistRes.json();
        status.textContent = `Created playlist: ${createdPlaylist.name}, adding tracks...`;

        for (let i = 0; i < trackURIs.length; i += 100) {
          const batch = trackURIs.slice(i, i + 100);
          await fetch(`https://api.spotify.com/v1/playlists/${createdPlaylist.id}/tracks`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ uris: batch }),
          });
        }

        status.textContent = "All tracks added to the new playlist!";
      } catch (error) {
        status.textContent = "Error merging playlists: " + error.message;
      }
    }

    document.getElementById("login-btn").addEventListener("click", () => {
      const authUrl =
        "https://accounts.spotify.com/authorize?" +
        new URLSearchParams({
          client_id: CLIENT_ID,
          redirect_uri: REDIRECT_URI,
          response_type: "token",
          scope: SCOPES,
        }).toString();
      window.location.href = authUrl;
    });

    document.getElementById("logout-btn").addEventListener("click", () => {
      clearToken();
      updateUI();
    });

    document.getElementById("merge-btn").addEventListener("click", () => {
      mergePlaylists();
    });

    window.onload = () => {
      const token = getTokenFromHash();
      if (token) {
        setToken(token);
        window.location.hash = "";
      }
      updateUI();
    };
  </script>
</body>
</html>
