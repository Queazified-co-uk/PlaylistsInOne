<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Playlists → One</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; text-align: center; }
    button { padding: 0.5rem 1rem; margin: 0.5rem; font-size: 1rem; }
    #status { margin-top: 1rem; color: green; }
  </style>
</head>
<body>
  <h1>Playlists → One</h1>
  <div id="login-section">
    <button id="login-btn">Login with Spotify</button>
  </div>
  <div id="app-section" style="display:none;">
    <button id="merge-btn">Merge My Playlists</button>
    <button id="logout-btn">Logout</button>
    <p id="status"></p>
  </div>

<script>
  // Helpers for PKCE: generate code verifier and code challenge
  function base64urlencode(str) {
    return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  async function sha256(plain) {
    const encoder = new TextEncoder();
    const data = encoder.encode(plain);
    return await crypto.subtle.digest('SHA-256', data);
  }

  function generateCodeVerifier() {
    const array = new Uint8Array(128);
    crypto.getRandomValues(array);
    return base64urlencode(array);
  }

  async function generateCodeChallenge(verifier) {
    const hashed = await sha256(verifier);
    return base64urlencode(hashed);
  }

  // Save and retrieve code verifier in localStorage
  function saveCodeVerifier(verifier) {
    localStorage.setItem('pkce_code_verifier', verifier);
  }
  function getCodeVerifier() {
    return localStorage.getItem('pkce_code_verifier');
  }
  function clearCodeVerifier() {
    localStorage.removeItem('pkce_code_verifier');
  }

  // Your config
  const client_id = '2cf9bbde938149269d0da9bb6438ab40';
  const redirect_uri = 'https://playlistsinone.queazified.co.uk/';
  const scopes = [
    "playlist-read-private",
    "playlist-read-collaborative",
    "playlist-modify-public",
    "playlist-modify-private"
  ].join(' ');

  async function login() {
    const verifier = generateCodeVerifier();
    saveCodeVerifier(verifier);
    const challenge = await generateCodeChallenge(verifier);

    const params = new URLSearchParams({
      client_id,
      response_type: 'code',
      redirect_uri,
      scope: scopes,
      code_challenge_method: 'S256',
      code_challenge: challenge,
    });

    window.location.href = 'https://accounts.spotify.com/authorize?' + params.toString();
  }

  async function handleRedirect() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    if (!code) return;

    const verifier = getCodeVerifier();
    if (!verifier) {
      console.error('Code verifier not found. Please try logging in again.');
      return;
    }

    // Exchange code + verifier via your proxy Worker
    try {
      const response = await fetch('https://spotifyauthproxy-pio.qzd.workers.dev/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          code,
          code_verifier: verifier,
          redirect_uri,
        }),
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(text);
      }

      const data = await response.json();
      console.log('Token data:', data);

      clearCodeVerifier();

      // Save your tokens as needed (e.g., localStorage)
      localStorage.setItem('spotify_token', data.access_token);

      // Clean URL (remove code param)
      window.history.replaceState({}, document.title, redirect_uri);

      // Continue your app flow (show UI, etc)
      updateUI();

    } catch (err) {
      console.error('Error exchanging code for token:', err);
      alert('Authentication failed, please try again.');
    }
  }

  function updateUI() {
    const token = localStorage.getItem('spotify_token');
    if (token) {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('app-section').style.display = 'block';
    } else {
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('app-section').style.display = 'none';
    }
  }

  window.onload = () => {
    updateUI();
    handleRedirect();

    document.getElementById('login-btn').onclick = () => login();
    document.getElementById('logout-btn').onclick = () => {
      localStorage.removeItem('spotify_token');
      updateUI();
    };
  };
</script>

</body>
</html>
