<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Playlists → One</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; text-align: center; }
    button { padding: 0.5rem 1rem; margin: 0.5rem; font-size: 1rem; }
    #status { margin-top: 1rem; color: green; }
  </style>
</head>
<body>
  <h1>Playlists → One</h1>
  <div id="login-section">
    <button id="login-btn">Login with Spotify</button>
  </div>
  <div id="app-section" style="display:none;">
    <button id="merge-btn">Merge My Playlists</button>
    <button id="logout-btn">Logout</button>
    <p id="status"></p>
  </div>

<script>
  const CLIENT_ID = "2cf9bbde938149269d0da9bb6438ab40";
  const REDIRECT_URI = window.location.origin + window.location.pathname; // Keep on same page
  const SCOPES = [
    "playlist-read-private",
    "playlist-read-collaborative",
    "playlist-modify-public",
    "playlist-modify-private"
  ].join(" ");

  function base64UrlEncode(arrayBuffer) {
    let str = '';
    const bytes = new Uint8Array(arrayBuffer);
    for (let i = 0; i < bytes.byteLength; i++) {
      str += String.fromCharCode(bytes[i]);
    }
    return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  function generateCodeVerifier(length = 128) {
    const array = new Uint8Array(length);
    crypto.getRandomValues(array);
    return base64UrlEncode(array);
  }

  async function generateCodeChallenge(codeVerifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(codeVerifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    return base64UrlEncode(digest);
  }

  function setCodeVerifier(verifier) {
    localStorage.setItem('code_verifier', verifier);
    console.log('code_verifier stored:', verifier);
  }
  function getCodeVerifier() {
    const v = localStorage.getItem('code_verifier');
    console.log('code_verifier read:', v);
    return v;
  }
  function clearCodeVerifier() {
    localStorage.removeItem('code_verifier');
  }

  function setAccessToken(token) {
    localStorage.setItem('spotify_token', token);
  }
  function getAccessToken() {
    return localStorage.getItem('spotify_token');
  }
  function clearAccessToken() {
    localStorage.removeItem('spotify_token');
  }

  function updateUI() {
    if (getAccessToken()) {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('app-section').style.display = 'block';
    } else {
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('app-section').style.display = 'none';
    }
  }

  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  async function exchangeCodeForToken(code) {
    const codeVerifier = getCodeVerifier();
    if (!codeVerifier) {
      alert('Code verifier not found. Please try logging in again.');
      return;
    }

    // IMPORTANT:
    // You MUST create a backend endpoint to exchange code for tokens securely.
    // Frontend cannot safely call Spotify's /api/token directly (would expose client_secret).
    // Replace the URL below with your backend endpoint that does the exchange.

    try {
      const response = await fetch('https://your-backend.example.com/exchange_token', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          client_id: CLIENT_ID,
          code,
          redirect_uri: REDIRECT_URI,
          code_verifier: codeVerifier,
        }),
      });

      if (!response.ok) throw new Error('Token exchange failed');

      const data = await response.json();
      const accessToken = data.access_token;
      if (accessToken) {
        setAccessToken(accessToken);
        clearCodeVerifier();
        updateUI();
        document.getElementById('status').textContent = 'Login successful!';
      } else {
        throw new Error('No access token returned');
      }
    } catch (err) {
      alert('Error exchanging code for token: ' + err.message);
    }
  }

  document.getElementById('login-btn').addEventListener('click', async () => {
    const codeVerifier = generateCodeVerifier();
    setCodeVerifier(codeVerifier);
    const codeChallenge = await generateCodeChallenge(codeVerifier);

    const params = new URLSearchParams({
      client_id: CLIENT_ID,
      response_type: 'code',
      redirect_uri: REDIRECT_URI,
      code_challenge_method: 'S256',
      code_challenge: codeChallenge,
      scope: SCOPES,
    });

    window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
  });

  document.getElementById('logout-btn').addEventListener('click', () => {
    clearAccessToken();
    clearCodeVerifier();
    updateUI();
    document.getElementById('status').textContent = '';
  });

  async function mergePlaylists() {
    const status = document.getElementById('status');
    const token = getAccessToken();
    if (!token) {
      status.textContent = 'Please login first.';
      return;
    }

    status.textContent = "Fetching playlists...";
    try {
      const playlistsRes = await fetch("https://api.spotify.com/v1/me/playlists?limit=50", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const playlistsData = await playlistsRes.json();
      const playlists = playlistsData.items;

      let trackURIs = [];
      for (const playlist of playlists) {
        const tracksRes = await fetch(playlist.tracks.href, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const tracksData = await tracksRes.json();
        trackURIs.push(...tracksData.items.map(item => item.track.uri));
      }

      const userRes = await fetch("https://api.spotify.com/v1/me", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const user = await userRes.json();

      const createPlaylistRes = await fetch(`https://api.spotify.com/v1/users/${user.id}/playlists`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          name: "Playlists → One",
          description: "Merged by playlistsinone.queazified.co.uk",
          public: false,
        }),
      });

      const createdPlaylist = await createPlaylistRes.json();
      status.textContent = `Created playlist: ${createdPlaylist.name}, adding tracks...`;

      for (let i = 0; i < trackURIs.length; i += 100) {
        const batch = trackURIs.slice(i, i + 100);
        await fetch(`https://api.spotify.com/v1/playlists/${createdPlaylist.id}/tracks`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ uris: batch }),
        });
      }

      status.textContent = "All tracks added to the new playlist!";
    } catch (error) {
      status.textContent = "Error merging playlists: " + error.message;
    }
  }

  document.getElementById('merge-btn').addEventListener('click', () => {
    mergePlaylists();
  });

  window.onload = async () => {
    const code = getQueryParam('code');
    if (code) {
      // Clean URL (remove code param)
      const newURL = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, newURL);

      // Exchange code for token
      await exchangeCodeForToken(code);
    }
    updateUI();
  };
</script>
</body>
</html>
